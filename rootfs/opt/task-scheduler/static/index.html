<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Scheduler Pro v1.1.0</title>
    <style>
        :root {
            --bg: #0f0f14;
            --card: #1a1a22;
            --border: #2a2a35;
            --accent: #6366f1;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text: #f1f5f9;
            --muted: #64748b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 1.5rem;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        .header h1 { font-size: 1.5rem; }
        .header small { color: var(--muted); font-size: 0.8rem; }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .grid { display: grid; grid-template-columns: 1fr 350px; gap: 1.5rem; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }
        .card-title {
            font-size: 0.9rem;
            color: var(--muted);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .task-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .task-item:hover { border-color: var(--accent); }
        .task-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem; }
        .task-name { font-weight: 600; }
        .task-badges { display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 0.5rem 0; }
        .badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: var(--border);
        }
        .badge-action { background: rgba(99,102,241,0.2); color: var(--accent); }
        .badge-schedule { background: rgba(16,185,129,0.2); color: var(--success); }
        .badge-sun { background: rgba(245,158,11,0.2); color: var(--warning); }
        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--muted);
        }
        .task-actions { display: flex; gap: 0.25rem; }
        .toggle { position: relative; width: 40px; height: 22px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; inset: 0;
            background: var(--border); border-radius: 22px; transition: 0.2s;
        }
        .toggle-slider:before {
            content: ""; position: absolute; height: 16px; width: 16px;
            left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.2s;
        }
        .toggle input:checked + .toggle-slider { background: var(--success); }
        .toggle input:checked + .toggle-slider:before { transform: translateX(18px); }
        .history-item { display: flex; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
        .history-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 4px; flex-shrink: 0; }
        .history-dot.ok { background: var(--success); }
        .history-dot.err { background: var(--danger); }
        .empty { text-align: center; padding: 2rem; color: var(--muted); }
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-bg.active { display: flex; }
        .modal { background: var(--card); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 1.1rem; }
        .modal-close { background: none; border: none; color: var(--muted); font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 1rem; }
        .modal-footer { padding: 1rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.75rem; color: var(--muted); margin-bottom: 0.25rem; text-transform: uppercase; }
        .form-control { width: 100%; padding: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 0.9rem; }
        .form-control:focus { outline: none; border-color: var(--accent); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .hidden { display: none !important; }
        .toast-box { position: fixed; bottom: 1rem; right: 1rem; z-index: 1100; }
        .toast { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 0.75rem 1rem; margin-top: 0.5rem; animation: slideIn 0.3s; }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .section-title { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; margin: 1rem 0 0.5rem 0; padding-top: 0.5rem; border-top: 1px solid var(--border); }
        input[type="color"] { -webkit-appearance: none; border: none; width: 50px; height: 35px; border-radius: 4px; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 4px; }
        input[type="range"] { width: 100%; accent-color: var(--accent); }
        .color-row { display: flex; align-items: center; gap: 0.75rem; }
        .slider-row { display: flex; align-items: center; gap: 0.5rem; }
        .slider-row input[type="range"] { flex: 1; }
        .slider-row span { min-width: 60px; text-align: right; font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>‚è± Task Scheduler Pro</h1>
            <small>v1.1.0 - Automated task management</small>
        </div>
        <button class="btn btn-primary" onclick="openModal()">+ New Task</button>
    </div>

    <div class="grid">
        <div>
            <div class="card">
                <div class="card-title">Scheduled Tasks</div>
                <div id="tasks-list"><div class="empty">Loading...</div></div>
            </div>
        </div>
        <div>
            <div class="card">
                <div class="card-title">Recent Activity</div>
                <div id="history-list"><div class="empty">No activity yet</div></div>
            </div>
        </div>
    </div>

    <div class="modal-bg" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">New Task</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>Task Name</label>
                    <input type="text" class="form-control" id="f-name" placeholder="My Task">
                </div>
                <div class="form-group">
                    <label>Action Type</label>
                    <select class="form-control" id="f-action" onchange="updateFields()">
                        <option value="">Select...</option>
                        <option value="reboot_host">üîÑ Reboot Host</option>
                        <option value="restart_ha">üè† Restart Home Assistant</option>
                        <option value="restart_addon">üì¶ Restart Add-on</option>
                        <option value="entity_control">üí° Control Device (On/Off)</option>
                        <option value="light_advanced">üé® Light Control (Color/Brightness)</option>
                        <option value="call_service">‚ö° Call Service</option>
                        <option value="automation">ü§ñ Trigger Automation</option>
                        <option value="script">üìú Run Script</option>
                        <option value="notify">üîî Send Notification</option>
                    </select>
                </div>
                
                <div class="form-group hidden" id="addon-group">
                    <label>Select Add-on</label>
                    <select class="form-control" id="f-addon"><option>Loading...</option></select>
                </div>
                
                <div class="form-group hidden" id="entity-group">
                    <label>Select Device</label>
                    <select class="form-control" id="f-entity"><option>Loading...</option></select>
                    <div style="margin-top:0.5rem">
                        <label>Action</label>
                        <select class="form-control" id="f-entity-action">
                            <option value="turn_on">Turn On</option>
                            <option value="turn_off">Turn Off</option>
                            <option value="toggle">Toggle</option>
                        </select>
                    </div>
                </div>
                
                <div class="hidden" id="light-group">
                    <div class="form-group">
                        <label>Select Light</label>
                        <select class="form-control" id="f-light"><option>Loading...</option></select>
                    </div>
                    <div class="form-group">
                        <label>Action</label>
                        <select class="form-control" id="f-light-action" onchange="updateLightFields()">
                            <option value="turn_on">Turn On</option>
                            <option value="turn_off">Turn Off</option>
                            <option value="toggle">Toggle</option>
                        </select>
                    </div>
                    <div id="light-options">
                        <div class="form-group">
                            <label>Brightness</label>
                            <div class="slider-row">
                                <input type="range" id="f-brightness" min="1" max="100" value="100">
                                <span id="brightness-val">100%</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Color Mode</label>
                            <select class="form-control" id="f-color-mode" onchange="updateColorMode()">
                                <option value="none">No color change</option>
                                <option value="color">Color (RGB)</option>
                                <option value="temp">Color Temperature</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="color-picker-group">
                            <label>Color</label>
                            <div class="color-row">
                                <input type="color" id="f-color" value="#ffffff">
                                <span id="color-hex">#ffffff</span>
                            </div>
                        </div>
                        <div class="form-group hidden" id="color-temp-group">
                            <label>Color Temperature</label>
                            <div class="slider-row">
                                <input type="range" id="f-color-temp" min="153" max="500" value="300">
                                <span id="temp-val">Warm</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Transition (seconds)</label>
                            <input type="number" class="form-control" id="f-transition" value="0" min="0" max="300" placeholder="0 = instant">
                        </div>
                    </div>
                </div>
                
                <div class="form-group hidden" id="service-group">
                    <div class="form-row">
                        <div><label>Domain</label><input type="text" class="form-control" id="f-domain" placeholder="light"></div>
                        <div><label>Service</label><input type="text" class="form-control" id="f-service" placeholder="turn_on"></div>
                    </div>
                    <div style="margin-top:0.5rem">
                        <label>Data (JSON)</label>
                        <textarea class="form-control" id="f-data" rows="2" placeholder='{"entity_id":"light.room"}'></textarea>
                    </div>
                </div>
                
                <div class="form-group hidden" id="automation-group">
                    <label>Select Automation</label>
                    <select class="form-control" id="f-automation"><option>Loading...</option></select>
                </div>
                
                <div class="form-group hidden" id="script-group">
                    <label>Select Script</label>
                    <select class="form-control" id="f-script"><option>Loading...</option></select>
                </div>
                
                <div class="hidden" id="notify-group">
                    <div class="form-group">
                        <label>Notification Service</label>
                        <select class="form-control" id="f-notify-service"><option>Loading...</option></select>
                    </div>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" class="form-control" id="f-notify-title" placeholder="Task Scheduler">
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea class="form-control" id="f-notify-message" rows="2" placeholder="Your message here"></textarea>
                    </div>
                </div>
                
                <div class="section-title">Schedule</div>
                <div class="form-group">
                    <label>Schedule Type</label>
                    <select class="form-control" id="f-schedule" onchange="updateSchedule()">
                        <option value="interval">Every X minutes/hours/days</option>
                        <option value="cron">At specific time daily</option>
                        <option value="sun">At sunrise / sunset</option>
                        <option value="once">One time only</option>
                    </select>
                </div>
                
                <div id="interval-group">
                    <div class="form-row">
                        <div class="form-group"><label>Every</label><input type="number" class="form-control" id="f-interval-val" value="1" min="1"></div>
                        <div class="form-group"><label>Unit</label>
                            <select class="form-control" id="f-interval-unit">
                                <option value="minutes">Minutes</option>
                                <option value="hours" selected>Hours</option>
                                <option value="days">Days</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div id="cron-group" class="hidden">
                    <div class="form-row">
                        <div class="form-group"><label>Hour (0-23)</label><input type="number" class="form-control" id="f-cron-hour" value="0" min="0" max="23"></div>
                        <div class="form-group"><label>Minute (0-59)</label><input type="number" class="form-control" id="f-cron-min" value="0" min="0" max="59"></div>
                    </div>
                    <div class="form-group">
                        <label>Days</label>
                        <select class="form-control" id="f-cron-dow">
                            <option value="*">Every day</option>
                            <option value="mon,tue,wed,thu,fri">Weekdays</option>
                            <option value="sat,sun">Weekends</option>
                            <option value="mon">Monday</option>
                            <option value="tue">Tuesday</option>
                            <option value="wed">Wednesday</option>
                            <option value="thu">Thursday</option>
                            <option value="fri">Friday</option>
                            <option value="sat">Saturday</option>
                            <option value="sun">Sunday</option>
                        </select>
                    </div>
                </div>
                
                <div id="sun-group" class="hidden">
                    <div class="form-group">
                        <label>Sun Event</label>
                        <select class="form-control" id="f-sun-event">
                            <option value="sunrise">üåÖ Sunrise</option>
                            <option value="sunset">üåá Sunset</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Offset</label>
                            <select class="form-control" id="f-sun-offset-dir">
                                <option value="before">Before</option>
                                <option value="after">After</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Minutes</label><input type="number" class="form-control" id="f-sun-offset" value="0" min="0" max="180"></div>
                    </div>
                </div>
                
                <div id="once-group" class="hidden">
                    <div class="form-group">
                        <label>Date and Time</label>
                        <input type="datetime-local" class="form-control" id="f-run-at">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>

    <div class="toast-box" id="toasts"></div>

    <script>
        console.log('Task Scheduler Pro v1.1.0 loading...');
        let tasks = {}, addons = [], automations = [], scripts = [], entities = [], lights = [], notifyServices = [];

        async function api(url, method = 'GET', body = null) {
            const relativeUrl = url.startsWith('/') ? '.' + url : url;
            const opts = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) opts.body = JSON.stringify(body);
            try {
                const res = await fetch(relativeUrl, opts);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return await res.json();
            } catch (err) { console.error('API error:', err); throw err; }
        }

        function toast(msg, type = 'info') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            document.getElementById('toasts').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        async function loadTasks() {
            try {
                const data = await api('./api/tasks');
                tasks = data.tasks || {};
                renderTasks();
                renderHistory(data.history || []);
            } catch (e) { console.error('Load tasks failed:', e); }
        }

        async function loadAddons() {
            try {
                addons = await api('./api/addons');
                document.getElementById('f-addon').innerHTML = addons.length ? 
                    '<option value="">Select...</option>' + addons.map(a => `<option value="${a.slug}">${a.name}</option>`).join('') : '<option>None</option>';
            } catch (e) { document.getElementById('f-addon').innerHTML = '<option>Error</option>'; }
        }

        async function loadAutomations() {
            try {
                automations = await api('./api/automations');
                document.getElementById('f-automation').innerHTML = automations.length ? 
                    '<option value="">Select...</option>' + automations.map(a => `<option value="${a.entity_id}">${a.attributes?.friendly_name || a.entity_id}</option>`).join('') : '<option>None</option>';
            } catch (e) { console.error(e); }
        }

        async function loadScripts() {
            try {
                scripts = await api('./api/scripts');
                document.getElementById('f-script').innerHTML = scripts.length ? 
                    '<option value="">Select...</option>' + scripts.map(s => `<option value="${s.entity_id}">${s.attributes?.friendly_name || s.entity_id}</option>`).join('') : '<option>None</option>';
            } catch (e) { console.error(e); }
        }

        async function loadEntities() {
            try {
                entities = await api('./api/entities');
                document.getElementById('f-entity').innerHTML = entities.length ? 
                    '<option value="">Select...</option>' + entities.map(e => `<option value="${e.entity_id}">${e.attributes?.friendly_name || e.entity_id}</option>`).join('') : '<option>None</option>';
            } catch (e) { console.error(e); }
        }

        async function loadLights() {
            try {
                lights = await api('./api/lights');
                document.getElementById('f-light').innerHTML = lights.length ? 
                    '<option value="">Select...</option>' + lights.map(l => `<option value="${l.entity_id}">${l.attributes?.friendly_name || l.entity_id}</option>`).join('') : '<option>None</option>';
            } catch (e) { console.error(e); }
        }

        async function loadNotifyServices() {
            try {
                notifyServices = await api('./api/notify_services');
                document.getElementById('f-notify-service').innerHTML = notifyServices.length ? 
                    '<option value="">Select...</option>' + notifyServices.map(n => `<option value="${n}">${n.replace('notify.', '')}</option>`).join('') : '<option>None</option>';
            } catch (e) { console.error(e); }
        }

        function renderTasks() {
            const list = document.getElementById('tasks-list');
            const items = Object.entries(tasks);
            if (!items.length) { list.innerHTML = '<div class="empty">No tasks yet. Create one!</div>'; return; }
            list.innerHTML = items.map(([id, t]) => `
                <div class="task-item" style="opacity:${t.enabled !== false ? 1 : 0.5}">
                    <div class="task-header">
                        <span class="task-name">${esc(t.name || 'Unnamed')}</span>
                        <label class="toggle"><input type="checkbox" ${t.enabled !== false ? 'checked' : ''} onchange="toggleTask('${id}')"><span class="toggle-slider"></span></label>
                    </div>
                    <div class="task-badges">
                        <span class="badge badge-action">${actionLabel(t.action_type)}</span>
                        <span class="badge ${t.schedule_type === 'sun' ? 'badge-sun' : 'badge-schedule'}">${scheduleLabel(t)}</span>
                    </div>
                    <div class="task-footer">
                        <span>${t.last_run ? 'Last: ' + timeAgo(t.last_run) : 'Never run'}</span>
                        <div class="task-actions">
                            <button class="btn btn-sm btn-success" onclick="runTask('${id}')">‚ñ∂</button>
                            <button class="btn btn-sm" onclick="editTask('${id}')">‚úé</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTask('${id}')">üóë</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderHistory(hist) {
            const list = document.getElementById('history-list');
            if (!hist.length) { list.innerHTML = '<div class="empty">No activity yet</div>'; return; }
            list.innerHTML = hist.slice().reverse().slice(0, 20).map(h => `
                <div class="history-item">
                    <div class="history-dot ${h.success ? 'ok' : 'err'}"></div>
                    <div><div>${esc(h.task_name)}</div><div style="color:var(--muted)">${esc(h.message)} - ${timeAgo(h.executed_at)}</div></div>
                </div>
            `).join('');
        }

        function esc(s) { return s ? String(s).replace(/</g, '&lt;').replace(/>/g, '&gt;') : ''; }
        function actionLabel(a) {
            const m = { reboot_host:'üîÑ Reboot', restart_ha:'üè† HA', restart_addon:'üì¶ Add-on', entity_control:'üí° Device', light_advanced:'üé® Light', call_service:'‚ö° Service', automation:'ü§ñ Auto', script:'üìú Script', notify:'üîî Notify' };
            return m[a] || a || '?';
        }
        function scheduleLabel(t) {
            if (t.schedule_type === 'cron') return `${String(t.cron_hour||0).padStart(2,'0')}:${String(t.cron_minute||0).padStart(2,'0')}`;
            if (t.schedule_type === 'sun') {
                const e = t.sun_event === 'sunset' ? 'üåá' : 'üåÖ';
                const o = t.sun_offset || 0;
                return o ? `${e} ${t.sun_offset_dir === 'before' ? '-' : '+'}${o}m` : e;
            }
            if (t.schedule_type === 'once') return 'Once';
            return `${t.interval_value || 1} ${(t.interval_unit || 'hours').slice(0,1)}`;
        }
        function timeAgo(iso) {
            if (!iso) return '';
            const diff = Date.now() - new Date(iso);
            if (diff < 60000) return 'now';
            if (diff < 3600000) return Math.floor(diff/60000) + 'm';
            if (diff < 86400000) return Math.floor(diff/3600000) + 'h';
            return new Date(iso).toLocaleDateString();
        }

        function updateFields() {
            const a = document.getElementById('f-action').value;
            document.getElementById('addon-group').classList.toggle('hidden', a !== 'restart_addon');
            document.getElementById('entity-group').classList.toggle('hidden', a !== 'entity_control');
            document.getElementById('light-group').classList.toggle('hidden', a !== 'light_advanced');
            document.getElementById('service-group').classList.toggle('hidden', a !== 'call_service');
            document.getElementById('automation-group').classList.toggle('hidden', a !== 'automation');
            document.getElementById('script-group').classList.toggle('hidden', a !== 'script');
            document.getElementById('notify-group').classList.toggle('hidden', a !== 'notify');
        }

        function updateSchedule() {
            const s = document.getElementById('f-schedule').value;
            document.getElementById('interval-group').classList.toggle('hidden', s !== 'interval');
            document.getElementById('cron-group').classList.toggle('hidden', s !== 'cron');
            document.getElementById('sun-group').classList.toggle('hidden', s !== 'sun');
            document.getElementById('once-group').classList.toggle('hidden', s !== 'once');
        }

        function updateLightFields() {
            document.getElementById('light-options').classList.toggle('hidden', document.getElementById('f-light-action').value === 'turn_off');
        }

        function updateColorMode() {
            const m = document.getElementById('f-color-mode').value;
            document.getElementById('color-picker-group').classList.toggle('hidden', m !== 'color');
            document.getElementById('color-temp-group').classList.toggle('hidden', m !== 'temp');
        }

        document.getElementById('f-brightness').addEventListener('input', e => document.getElementById('brightness-val').textContent = e.target.value + '%');
        document.getElementById('f-color').addEventListener('input', e => document.getElementById('color-hex').textContent = e.target.value);
        document.getElementById('f-color-temp').addEventListener('input', e => {
            const v = +e.target.value;
            document.getElementById('temp-val').textContent = v < 250 ? 'Warm' : v < 350 ? 'Neutral' : 'Cool';
        });

        function openModal(id = null) {
            document.getElementById('modal-title').textContent = id ? 'Edit Task' : 'New Task';
            document.getElementById('edit-id').value = id || '';
            const t = id ? tasks[id] : {};
            document.getElementById('f-name').value = t.name || '';
            document.getElementById('f-action').value = t.action_type || '';
            document.getElementById('f-addon').value = t.addon_slug || '';
            document.getElementById('f-entity').value = t.entity_id || '';
            document.getElementById('f-entity-action').value = t.entity_action || 'turn_on';
            document.getElementById('f-light').value = t.light_entity_id || '';
            document.getElementById('f-light-action').value = t.light_action || 'turn_on';
            document.getElementById('f-brightness').value = t.brightness ?? 100;
            document.getElementById('brightness-val').textContent = (t.brightness ?? 100) + '%';
            document.getElementById('f-color-mode').value = t.color_mode || 'none';
            document.getElementById('f-color').value = t.color || '#ffffff';
            document.getElementById('color-hex').textContent = t.color || '#ffffff';
            document.getElementById('f-color-temp').value = t.color_temp || 300;
            document.getElementById('f-transition').value = t.transition || 0;
            document.getElementById('f-domain').value = t.service_domain || '';
            document.getElementById('f-service').value = t.service_name || '';
            document.getElementById('f-data').value = t.service_data ? JSON.stringify(t.service_data) : '';
            document.getElementById('f-automation').value = t.automation_id || '';
            document.getElementById('f-script').value = t.script_id || '';
            document.getElementById('f-notify-service').value = t.notify_service || '';
            document.getElementById('f-notify-title').value = t.notify_title || 'Task Scheduler';
            document.getElementById('f-notify-message').value = t.notify_message || '';
            document.getElementById('f-schedule').value = t.schedule_type || 'interval';
            document.getElementById('f-interval-val').value = t.interval_value || 1;
            document.getElementById('f-interval-unit').value = t.interval_unit || 'hours';
            document.getElementById('f-cron-hour').value = t.cron_hour ?? 0;
            document.getElementById('f-cron-min').value = t.cron_minute ?? 0;
            document.getElementById('f-cron-dow').value = t.cron_dow || '*';
            document.getElementById('f-sun-event').value = t.sun_event || 'sunrise';
            document.getElementById('f-sun-offset-dir').value = t.sun_offset_dir || 'after';
            document.getElementById('f-sun-offset').value = t.sun_offset || 0;
            const defDate = new Date(); defDate.setHours(defDate.getHours() + 1);
            document.getElementById('f-run-at').value = t.run_at || defDate.toISOString().slice(0,16);
            updateFields(); updateSchedule(); updateLightFields(); updateColorMode();
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() { document.getElementById('modal').classList.remove('active'); }

        async function saveTask() {
            const id = document.getElementById('edit-id').value;
            let svcData = {};
            try { const r = document.getElementById('f-data').value; if (r) svcData = JSON.parse(r); } catch { toast('Invalid JSON', 'error'); return; }
            const data = {
                name: document.getElementById('f-name').value,
                action_type: document.getElementById('f-action').value,
                addon_slug: document.getElementById('f-addon').value,
                entity_id: document.getElementById('f-entity').value,
                entity_action: document.getElementById('f-entity-action').value,
                light_entity_id: document.getElementById('f-light').value,
                light_action: document.getElementById('f-light-action').value,
                brightness: +document.getElementById('f-brightness').value,
                color_mode: document.getElementById('f-color-mode').value,
                color: document.getElementById('f-color').value,
                color_temp: +document.getElementById('f-color-temp').value,
                transition: +document.getElementById('f-transition').value || 0,
                service_domain: document.getElementById('f-domain').value,
                service_name: document.getElementById('f-service').value,
                service_data: svcData,
                automation_id: document.getElementById('f-automation').value,
                script_id: document.getElementById('f-script').value,
                notify_service: document.getElementById('f-notify-service').value,
                notify_title: document.getElementById('f-notify-title').value,
                notify_message: document.getElementById('f-notify-message').value,
                schedule_type: document.getElementById('f-schedule').value,
                interval_value: +document.getElementById('f-interval-val').value || 1,
                interval_unit: document.getElementById('f-interval-unit').value,
                cron_hour: +document.getElementById('f-cron-hour').value || 0,
                cron_minute: +document.getElementById('f-cron-min').value || 0,
                cron_dow: document.getElementById('f-cron-dow').value,
                sun_event: document.getElementById('f-sun-event').value,
                sun_offset_dir: document.getElementById('f-sun-offset-dir').value,
                sun_offset: +document.getElementById('f-sun-offset').value || 0,
                run_at: document.getElementById('f-run-at').value
            };
            try {
                await api(id ? `./api/tasks/${id}` : './api/tasks', id ? 'PUT' : 'POST', data);
                toast('Saved!', 'success'); closeModal(); loadTasks();
            } catch (e) { toast('Failed: ' + e.message, 'error'); }
        }

        async function toggleTask(id) { await api(`./api/tasks/${id}/toggle`, 'POST'); loadTasks(); }
        async function runTask(id) { toast('Running...'); const r = await api(`./api/tasks/${id}/run`, 'POST'); toast(r.success ? 'Done!' : r.message, r.success ? 'success' : 'error'); loadTasks(); }
        function editTask(id) { openModal(id); }
        async function deleteTask(id) { if (!confirm('Delete?')) return; await api(`./api/tasks/${id}`, 'DELETE'); toast('Deleted', 'success'); loadTasks(); }

        document.addEventListener('DOMContentLoaded', () => {
            loadTasks(); loadAddons(); loadAutomations(); loadScripts(); loadEntities(); loadLights(); loadNotifyServices();
            setInterval(loadTasks, 30000);
        });
        document.getElementById('modal').addEventListener('click', e => { if (e.target.classList.contains('modal-bg')) closeModal(); });
    </script>
</body>
</html>
